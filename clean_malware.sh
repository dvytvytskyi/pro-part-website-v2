#!/bin/bash
#
# Скрипт для видалення шкідливих файлів з зламаного WordPress сайту
# УВАГА: Використовуйте на свій ризик! Зробіть бекап перед запуском!
#
# Дата: 20 жовтня 2025
#

set -e

# Кольори для виводу
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

SITE_PATH="/Users/vytvytskyi/Downloads/htdocs/pro-part.es"

echo -e "${RED}╔═══════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║  ⚠️  ВИДАЛЕННЯ ШКІДЛИВИХ ФАЙЛІВ                                   ║${NC}"
echo -e "${RED}╚═══════════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${YELLOW}УВАГА: Цей скрипт видалить заражені файли!${NC}"
echo -e "${YELLOW}Переконайтеся що у вас є резервна копія!${NC}"
echo ""
echo -n "Продовжити? (так/ні): "
read CONFIRM

if [ "$CONFIRM" != "так" ] && [ "$CONFIRM" != "yes" ]; then
    echo -e "${RED}Операцію скасовано.${NC}"
    exit 1
fi

cd "$SITE_PATH"

echo ""
echo -e "${GREEN}Починаємо очищення...${NC}"
echo ""

# Функція для видалення файлу
remove_file() {
    if [ -f "$1" ]; then
        echo -e "${YELLOW}Видаляємо:${NC} $1"
        rm -f "$1"
    else
        echo -e "${GREEN}Вже відсутній:${NC} $1"
    fi
}

# Функція для видалення папки
remove_dir() {
    if [ -d "$1" ]; then
        echo -e "${YELLOW}Видаляємо папку:${NC} $1"
        rm -rf "$1"
    else
        echo -e "${GREEN}Вже відсутня:${NC} $1"
    fi
}

echo "═══════════════════════════════════════════════════════════════════"
echo "1. Видаляємо головні backdoor файли..."
echo "═══════════════════════════════════════════════════════════════════"

remove_file "wp-class.php"
remove_file "wp-class.gz"
remove_file "defaults.php"
remove_file "options.php"
remove_file "product.php"
remove_file "search.php"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "2. Видаляємо підозрілі папки в корені..."
echo "═══════════════════════════════════════════════════════════════════"

remove_dir "d65be"
remove_dir "d65be+55"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "3. Видаляємо заражені файли в wp-admin..."
echo "═══════════════════════════════════════════════════════════════════"

remove_dir "wp-admin/maint/310698"
remove_dir "wp-admin/network/511825"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "4. Видаляємо заражені файли в wp-includes..."
echo "═══════════════════════════════════════════════════════════════════"

remove_dir "wp-includes/block-supports/790602"
remove_dir "wp-includes/pomo/352882"
remove_dir "wp-includes/html-api/296918"
remove_dir "wp-includes/sitemaps/providers/996923"
remove_dir "wp-includes/images/media/756030"
remove_dir "wp-includes/css/dist/list-reusable-blocks/682616"
remove_dir "wp-includes/css/dist/block-directory/499437"
remove_dir "wp-includes/SimplePie/library/SimplePie/Decode/cloudflare"
remove_dir "wp-includes/sodium_compat/src/Core32/Poly1305/i18ns"
remove_dir "wp-includes/sodium_compat/src/Core/ChaCha20/i18ns"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "5. Видаляємо заражені файли в темах..."
echo "═══════════════════════════════════════════════════════════════════"

remove_file "wp-content/themes/propart-spain/icons/map/galleries/index.php"
remove_file "wp-content/themes/propart-spain/images/areapage/index.php"
remove_file "wp-content/themes/propart-spain/images/benahavispage/requests/index.php"
remove_file "wp-content/themes/propart-spain/images/marbellapage/index.php"
remove_file "wp-content/themes/propart-spain/assets/blog-sorting/index.php"
remove_dir "wp-content/themes/twentytwentyfive/assets/css/cloudflare"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "6. Видаляємо заражені файли в плагінах..."
echo "═══════════════════════════════════════════════════════════════════"

remove_file "wp-content/plugins/akismet/template-singl-portfolio.php"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "7. Очищаємо index.php (видаляємо перший рядок)..."
echo "═══════════════════════════════════════════════════════════════════"

if [ -f "index.php" ]; then
    # Перевіряємо чи є шкідливий рядок
    if grep -q "compress.zlib://wp-class.gz" index.php; then
        echo -e "${YELLOW}Знайдено шкідливий код в index.php, очищаємо...${NC}"
        # Видаляємо перший рядок
        sed -i.backup '1d' index.php
        echo -e "${GREEN}index.php очищено! Бекап збережено як index.php.backup${NC}"
    else
        echo -e "${GREEN}index.php чистий${NC}"
    fi
else
    echo -e "${RED}index.php не знайдено!${NC}"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "8. Шукаємо інші підозрілі файли..."
echo "═══════════════════════════════════════════════════════════════════"

# Шукаємо всі папки з числовими назвами
echo "Шукаємо папки з підозрілими числовими назвами..."
SUSPICIOUS_DIRS=$(find . -type d -name "[0-9][0-9][0-9][0-9][0-9][0-9]" 2>/dev/null)

if [ -n "$SUSPICIOUS_DIRS" ]; then
    echo -e "${YELLOW}Знайдено підозрілі папки:${NC}"
    echo "$SUSPICIOUS_DIRS"
    echo ""
    echo -n "Видалити їх? (так/ні): "
    read CONFIRM_DIRS
    
    if [ "$CONFIRM_DIRS" = "так" ] || [ "$CONFIRM_DIRS" = "yes" ]; then
        echo "$SUSPICIOUS_DIRS" | while read dir; do
            remove_dir "$dir"
        done
    fi
else
    echo -e "${GREEN}Додаткових підозрілих папок не знайдено${NC}"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo -e "${GREEN}✅ ОЧИЩЕННЯ ЗАВЕРШЕНО!${NC}"
echo "═══════════════════════════════════════════════════════════════════"
echo ""
echo -e "${YELLOW}ВАЖЛИВО - ЩО РОБИТИ ДАЛІ:${NC}"
echo ""
echo "1. ❗ НЕГАЙНО змініть всі паролі:"
echo "   - WordPress admin"
echo "   - База даних (в wp-config.php)"
echo "   - FTP/SSH"
echo "   - Хостинг"
echo ""
echo "2. ❗ Оновіть ключі безпеки в wp-config.php:"
echo "   https://api.wordpress.org/secret-key/1.1/salt/"
echo ""
echo "3. ❗ Оновіть WordPress, теми та плагіни до останніх версій"
echo ""
echo "4. ❗ Встановіть плагін безпеки (Wordfence або Sucuri)"
echo ""
echo "5. ❗ Проскануйте сайт онлайн:"
echo "   https://sitecheck.sucuri.net"
echo ""
echo "6. ❗ Перевірте .htaccess на наявність шкідливих правил"
echo ""
echo "7. ❗ Перевірте чи сайт відкривається без редиректів"
echo ""
echo -e "${RED}⚠️  Контролюйте сайт щодня протягом тижня!${NC}"
echo ""

